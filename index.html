<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>画像明かしブロック崩し - シンプル版</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: white;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        
        #gameContainer {
            position: relative;
            width: 800px;
            max-width: 95vw;
            margin: 0 auto;
        }
        
        #gameCanvas {
            background-color: #000;
            display: block;
            margin: 0 auto;
            max-width: 100%;
        }
        
        #startScreen {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .btn {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px 2px;
            cursor: pointer;
            border-radius: 5px;
        }
        
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .uploadContainer {
            margin: 10px 0;
        }
        
        .imagePreview {
            max-width: 200px;
            max-height: 100px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="startScreen">
            <h1>画像明かしブロック崩し</h1>
            <p>2枚の画像をアップロードしてゲームを始めよう！</p>
            
            <div class="uploadContainer">
                <p>表の画像:</p>
                <input type="file" id="frontImage" accept="image/*">
                <div>
                    <img id="frontPreview" class="imagePreview" style="display:none;">
                </div>
            </div>
            
            <div class="uploadContainer">
                <p>背景の画像:</p>
                <input type="file" id="backImage" accept="image/*">
                <div>
                    <img id="backPreview" class="imagePreview" style="display:none;">
                </div>
            </div>
            
            <button id="startButton" class="btn" disabled>ゲームスタート</button>
        </div>
        
        <canvas id="gameCanvas" style="display:none;"></canvas>
        
        <div id="gameControls" style="display:none;">
            <button id="restartButton" class="btn">リスタート</button>
        </div>
    </div>

    <script>
        // ページ読み込み完了時に実行
        window.onload = function() {
            console.log("ページが完全に読み込まれました");
            
            // DOM要素の取得
            const frontImageInput = document.getElementById('frontImage');
            const backImageInput = document.getElementById('backImage');
            const frontPreview = document.getElementById('frontPreview');
            const backPreview = document.getElementById('backPreview');
            const startButton = document.getElementById('startButton');
            const restartButton = document.getElementById('restartButton');
            const startScreen = document.getElementById('startScreen');
            const gameCanvas = document.getElementById('gameCanvas');
            const gameControls = document.getElementById('gameControls');
            
            // ゲーム設定
            const game = {
                frontImage: null,
                backImage: null,
                canvas: gameCanvas,
                ctx: gameCanvas.getContext('2d'),
                width: 800,
                height: 450,
                started: false,
                
                // ブロック設定
                blockRows: 5,
                blockCols: 8,
                blocks: [],
                
                // パドルとボール
                paddle: { width: 100, height: 15, x: 350, y: 420 },
                ball: { x: 400, y: 400, radius: 8, dx: 4, dy: -4 }
            };
            
            // 画像アップロードイベント
            frontImageInput.addEventListener('change', function(e) {
                handleImageUpload(e, 'front');
            });
            
            backImageInput.addEventListener('change', function(e) {
                handleImageUpload(e, 'back');
            });
            
            // 画像アップロード処理
            function handleImageUpload(e, type) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        console.log(`${type}画像が読み込まれました: ${img.width}x${img.height}`);
                        
                        if (type === 'front') {
                            game.frontImage = img;
                            frontPreview.src = event.target.result;
                            frontPreview.style.display = 'block';
                        } else {
                            game.backImage = img;
                            backPreview.src = event.target.result;
                            backPreview.style.display = 'block';
                        }
                        
                        // 両方の画像があればスタートボタンを有効化
                        if (game.frontImage && game.backImage) {
                            startButton.disabled = false;
                        }
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            // スタートボタンイベント
            startButton.addEventListener('click', startGame);
            restartButton.addEventListener('click', restartGame);
            
            // ゲーム開始
            function startGame() {
                // キャンバスサイズ設定
                game.width = Math.min(800, window.innerWidth * 0.95);
                game.height = game.width * (9/16); // 16:9アスペクト比
                
                gameCanvas.width = game.width;
                gameCanvas.height = game.height;
                
                // UI切り替え
                startScreen.style.display = 'none';
                gameCanvas.style.display = 'block';
                gameControls.style.display = 'block';
                
                // パドル位置初期化
                game.paddle.x = (game.width - game.paddle.width) / 2;
                game.paddle.y = game.height - game.paddle.height - 10;
                
                // ボール位置初期化
                game.ball.x = game.width / 2;
                game.ball.y = game.height - game.paddle.height - game.ball.radius - 15;
                
                // ブロック生成
                createBlocks();
                
                // マウス操作設定
                gameCanvas.addEventListener('mousemove', movepaddle);
                
                // ゲーム開始
                game.started = true;
                gameLoop();
            }
            
            // パドル移動
            function movepaddle(e) {
                const rect = gameCanvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                
                // パドルの位置更新
                game.paddle.x = mouseX - (game.paddle.width / 2);
                
                // 範囲制限
                if (game.paddle.x < 0) {
                    game.paddle.x = 0;
                } else if (game.paddle.x + game.paddle.width > game.width) {
                    game.paddle.x = game.width - game.paddle.width;
                }
            }
            
            // ブロック生成
            function createBlocks() {
                game.blocks = [];
                
                const blockWidth = game.width / game.blockCols;
                const blockHeight = (game.height * 0.3) / game.blockRows;
                
                for (let r = 0; r < game.blockRows; r++) {
                    for (let c = 0; c < game.blockCols; c++) {
                        game.blocks.push({
                            x: c * blockWidth,
                            y: r * blockHeight,
                            width: blockWidth,
                            height: blockHeight,
                            visible: true
                        });
                    }
                }
            }
            
            // ゲームループ
            function gameLoop() {
                if (!game.started) return;
                
                // キャンバスクリア
                game.ctx.clearRect(0, 0, game.width, game.height);
                
                // 背景画像描画
                if (game.backImage) {
                    game.ctx.drawImage(game.backImage, 0, 0, game.width, game.height);
                }
                
                // ブロック描画
                drawBlocks();
                
                // パドル描画
                game.ctx.fillStyle = '#0095DD';
                game.ctx.fillRect(game.paddle.x, game.paddle.y, game.paddle.width, game.paddle.height);
                
                // ボール描画
                game.ctx.beginPath();
                game.ctx.arc(game.ball.x, game.ball.y, game.ball.radius, 0, Math.PI * 2);
                game.ctx.fillStyle = '#FF6347';
                game.ctx.fill();
                game.ctx.closePath();
                
                // ボール移動
                game.ball.x += game.ball.dx;
                game.ball.y += game.ball.dy;
                
                // 壁との衝突判定
                if (game.ball.x + game.ball.radius > game.width || game.ball.x - game.ball.radius < 0) {
                    game.ball.dx = -game.ball.dx;
                }
                
                if (game.ball.y - game.ball.radius < 0) {
                    game.ball.dy = -game.ball.dy;
                }
                
                // パドルとの衝突判定
                if (game.ball.y + game.ball.radius > game.paddle.y && 
                    game.ball.x > game.paddle.x && 
                    game.ball.x < game.paddle.x + game.paddle.width) {
                    game.ball.dy = -game.ball.dy;
                }
                
                // ブロックとの衝突判定
                for (let i = 0; i < game.blocks.length; i++) {
                    const block = game.blocks[i];
                    if (block.visible && 
                        game.ball.x > block.x && 
                        game.ball.x < block.x + block.width && 
                        game.ball.y > block.y && 
                        game.ball.y < block.y + block.height) {
                        game.ball.dy = -game.ball.dy;
                        block.visible = false;
                    }
                }
                
                // 下の壁に当たったらリセット
                if (game.ball.y + game.ball.radius > game.height) {
                    resetBall();
                }
                
                // 次のフレーム
                requestAnimationFrame(gameLoop);
            }
            
            // ブロック描画
            function drawBlocks() {
                for (let i = 0; i < game.blocks.length; i++) {
                    const block = game.blocks[i];
                    if (block.visible) {
                        // 表の画像の該当部分を描画
                        if (game.frontImage) {
                            // ソース画像の該当部分を計算
                            const sourceX = (block.x / game.width) * game.frontImage.width;
                            const sourceY = (block.y / game.height) * game.frontImage.height;
                            const sourceWidth = (block.width / game.width) * game.frontImage.width;
                            const sourceHeight = (block.height / game.height) * game.frontImage.height;
                            
                            // 対応する部分をブロックとして描画
                            game.ctx.drawImage(
                                game.frontImage,
                                sourceX, sourceY, sourceWidth, sourceHeight,
                                block.x, block.y, block.width, block.height
                            );
                        } else {
                            // デフォルトブロック
                            game.ctx.fillStyle = '#0095DD';
                            game.ctx.fillRect(block.x, block.y, block.width, block.height);
                        }
                        
                        // 枠線
                        game.ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
                        game.ctx.strokeRect(block.x, block.y, block.width, block.height);
                    }
                }
            }
            
            // ボールリセット
            function resetBall() {
                game.ball.x = game.width / 2;
                game.ball.y = game.height - game.paddle.height - game.ball.radius - 15;
                game.ball.dx = 4 * (Math.random() > 0.5 ? 1 : -1);
                game.ball.dy = -4;
            }
            
            // リスタート
            function restartGame() {
                game.started = false;
                
                startScreen.style.display = 'block';
                gameCanvas.style.display = 'none';
                gameControls.style.display = 'none';
                
                // 入力フィールドリセット
                frontImageInput.value = '';
                backImageInput.value = '';
                frontPreview.style.display = 'none';
                backPreview.style.display = 'none';
                startButton.disabled = true;
                
                game.frontImage = null;
                game.backImage = null;
            }
        };
    </script>
</body>
</html>
